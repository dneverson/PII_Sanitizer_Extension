(()=>{"use strict";let e=[],t=[],n=!1,o=!1,i=!1;function a(){const e=window.location.hostname;return t.some((t=>t.enabled&&e.includes(t.url)))}function s(e){return e instanceof HTMLTextAreaElement&&"none"===e.style.display&&"true"===e.getAttribute("data-virtualkeyboard")}function l(e){return"prompt-textarea"===e.id&&e.classList.contains("ProseMirror")}function r(e){return e.matches('textarea[placeholder*="Message Claude"]')||e.isContentEditable&&e.classList.contains("ProseMirror")&&window.location.hostname.includes("claude.ai")}function c(e){return e.split("\n").map((e=>`<p>${e||'<br class="ProseMirror-trailingBreak">'}</p>`)).join("")}function d(e){return e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").map((e=>`<p>${e}</p>`)).join("")}function u(e,t){if(t){const t=e.getElementsByTagName("p");return Array.from(t).map((e=>e.textContent?.replace(/\u200B/g,"")||"")).join("\n")}return e.textContent||""}function g(t,o=null,i=!1){if(console.log("Sanitizing text:",{text:t,cursorPosition:o,isPaste:i}),!t||n)return console.log("Text empty or globally paused, returning original"),{text:t||"",cursorPosition:o};let a=t.replace(/\r\n/g,"\n").replace(/\r/g,"\n"),s=o,l=-1,r=0;const c=a.split(/(\n)/),d=[];for(const t of c){if("\n"===t){d.push(t),r+=t.length;continue}let n=t;for(const t of e)if(t.enabled)try{const e=n;if(t.isRegex){const e=new RegExp(t.pattern,"g");n=n.replace(e,t.replacement)}else{const a=t.pattern.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=new RegExp(a,"g");let c;for(;null!==(c=s.exec(e));)if(null!==o&&!i){const e=r+c.index;e<=o&&(l=e+t.replacement.length)}n=n.replace(s,t.replacement)}}catch(e){console.error("Error applying sanitization rule:",{rule:t,error:e})}d.push(n),r+=t.length}return a=d.join(""),null!==o&&(s=i?a.length:l>=0?l:o===t.length?a.length:Math.min(o,a.length)),{text:a,cursorPosition:s}}function p(e){if(n||i)return;const t=e.target;if(s(t))return;let o=null,a=null;const p=l(t),m=r(t);if(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)o=t.value,a=t.selectionStart;else if(t instanceof HTMLElement&&t.isContentEditable){o=u(t,p||m);const e=window.getSelection();e&&e.rangeCount>0&&(a=e.getRangeAt(0).startOffset)}if(null!==o){const e="true"===t.dataset.justPasted,{text:n,cursorPosition:s}=g(o,a,e);if(n!==o){i=!0;try{if(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)t.value=n,null!==s&&t.setSelectionRange(s,s);else if(t instanceof HTMLElement&&t.isContentEditable&&(p?t.innerHTML=c(n):m?t.innerHTML=d(n):t.textContent=n,null!==s&&window.getSelection)){const e=window.getSelection();if(e)try{const o=document.createRange();if(p||m){const e=t.lastElementChild||t;o.selectNodeContents(e),o.collapse(!1)}else if(t.firstChild){const e=Math.min(s,n.length);o.setStart(t.firstChild,e),o.setEnd(t.firstChild,e)}e.removeAllRanges(),e.addRange(o)}catch(n){console.error("Error setting cursor position:",n);const o=document.createRange();o.selectNodeContents(t),o.collapse(!1),e.removeAllRanges(),e.addRange(o)}}}finally{i=!1,delete t.dataset.justPasted}}}}function m(e){if(console.log("=== PASTE EVENT START ==="),console.log("Initial target:",{element:e.target,id:e.target.id,classList:e.target.classList,parentElement:e.target.parentElement?.id}),n||i)return void console.log("Skipping due to pause/programmatic update");const t=e.target;if(s(t))return void console.log("Skipping hidden textarea");t.dataset.justPasted="true";const o=l(t),a=r(t);o||a?setTimeout((()=>{console.log("=== POST PASTE PROCESSING FOR EDITOR ===");const e=u(t,!0);console.log("Current content:",e);const{text:n}=g(e,null,!0);if(console.log("Sanitized content:",n),e!==n){i=!0;try{t.innerHTML=o?c(n):d(n);const e=window.getSelection();if(e){const n=document.createRange(),o=t.lastElementChild||t;n.selectNodeContents(o),n.collapse(!1),e.removeAllRanges(),e.addRange(n)}}finally{i=!1,delete t.dataset.justPasted}}}),0):console.log("Standard paste handling - letting input handler process"),console.log("=== PASTE PROCESSING COMPLETE ===")}function f(e){return!s(e)&&(['div[contenteditable="true"]#prompt-textarea','textarea.text-input:not([style*="display: none"])','textarea[placeholder*="Message Claude"]','div[contenteditable="true"]','textarea[placeholder*="Enter a prompt"]','div[contenteditable="true"][aria-label*="Prompt"]'].some((t=>e.matches(t)))||e.matches('input[type="text"], textarea:not([style*="display: none"])'))}function h(){const e=document.createElement("style");e.textContent="\n    .pii-monitored {\n      border: 2px solid #22c55e !important;\n      transition: border-color 0.3s ease;\n      border-radius: 5px;\n    }\n    .pii-monitored:focus {\n      border-color: #16a34a !important;\n      border-radius: 5px;\n    }\n  ",document.head.appendChild(e);const t=function(){let e;return function(...t){clearTimeout(e),e=setTimeout((()=>{clearTimeout(e),(()=>{document.querySelectorAll('input[type="text"], textarea, div[contenteditable="true"]').forEach((e=>{e instanceof HTMLElement&&function(e){!e.classList.contains("pii-monitored")&&f(e)&&(console.log("Setting up input:",e),e.classList.add("pii-monitored"),e.removeEventListener("input",p),e.removeEventListener("paste",m),e.addEventListener("input",p),e.addEventListener("paste",m))}(e)}))})(...t)}),100)}}();t(),new MutationObserver((e=>{let n=!1;e.forEach((e=>{("childList"===e.type&&e.addedNodes.length>0||"attributes"===e.type&&e.target instanceof HTMLElement&&f(e.target))&&(n=!0)})),n&&t()})).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["contenteditable","class","id","style"]}),setInterval(t,2e3)}console.log("Loading settings..."),chrome.storage.local.get(["sanitizations","websites","isGloballyPaused"],(i=>{e=i.sanitizations||[],t=i.websites||[],n=i.isGloballyPaused||!1,console.log("Settings loaded:",{sanitizations:e,websites:t,isGloballyPaused:n}),a()&&!o&&(console.log("Initializing monitoring..."),o=!0,h())})),chrome.storage.onChanged.addListener((i=>{console.log("Storage changes:",i),i.sanitizations&&(e=i.sanitizations.newValue),i.websites&&(t=i.websites.newValue,a()&&!o&&(o=!0,h())),i.isGloballyPaused&&(n=i.isGloballyPaused.newValue)}))})();